<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iBandbyte â€” Artists</title>
  <style>
    :root{
      --byte:#FFB100;
      --ink:#0A0A0A;
      --cardGrad1:#6a11cb;
      --cardGrad2:#ff6600;
      --panel:#161616;
      --chip:#2a2227;
      --soft:#aaa;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:28px 20px 60px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#fff; background:#111}
    header{max-width:980px; margin:0 auto 18px; display:flex; align-items:center; gap:14px}
    .logo{width:44px; height:44px; border-radius:12px; overflow:hidden; background:#1b1b1b; box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05); display:grid; place-items:center}
    .logo img{width:100%; height:100%; object-fit:cover}
    .brand{font-weight:800; font-size:34px; letter-spacing:.2px; line-height:1}
    .brand .iband{color:#fff}
    .brand .byte{color:var(--byte)}
    .controls{max-width:980px; margin:6px auto 18px}
    .search-row{display:flex; gap:12px; align-items:center}
    input[type="text"]{flex:1; padding:14px 16px; border:none; outline:none; color:#fff; background:#222; border-radius:10px; font-size:16px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
    .btn{padding:12px 18px; border:none; border-radius:10px; color:#fff; cursor:pointer; font-weight:700; letter-spacing:.2px; background:linear-gradient(90deg, var(--cardGrad1), var(--cardGrad2)); box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .wrap{max-width:980px; margin:0 auto}
    .card{background:linear-gradient(145deg, var(--cardGrad1), var(--cardGrad2)); border-radius:var(--radius); padding:22px; margin:16px 0; color:#fff; box-shadow:0 10px 28px rgba(0,0,0,.45); transition:transform .15s ease, box-shadow .15s ease; cursor:pointer}
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 34px rgba(0,0,0,.55)}
    .row{display:flex; align-items:center; gap:14px; margin-bottom:8px}
    .avatar{width:64px; height:64px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffd79a, #ff9f6b 50%, #ff7f50 70%); display:grid; place-items:center; font-weight:900; font-size:22px; color:#2b1a12; box-shadow:inset 0 0 0 2px rgba(255,255,255,.35), 0 6px 18px rgba(0,0,0,.25); flex:0 0 64px}
    .thumb{width:64px; height:64px; border-radius:50%; object-fit:cover; flex:0 0 64px; box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.25)}
    .name{font-size:28px; font-weight:800; margin:0}
    .genre{margin:6px 0 10px; color:#f3f3f3; font-size:18px}
    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{background:var(--chip); color:#f0e6e9; padding:8px 12px; border-radius:100px; font-size:13px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .voteBtn{margin-left:auto; font-weight:800; padding:8px 12px; border:none; border-radius:10px; color:#fff; background:rgba(0,0,0,.28); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); cursor:pointer}
    .voteBtn:disabled{opacity:.6; cursor:not-allowed}
    .pager{max-width:980px; margin:14px auto 0; display:flex; gap:10px; align-items:center; justify-content:center}
    .pager .info{color:var(--soft); font-size:14px; padding:8px 10px}
    .pager .pbtn{padding:10px 14px; border-radius:10px; border:none; cursor:pointer; color:#fff; background:#2b2b2b; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .pager .pbtn[disabled]{opacity:.45; cursor:not-allowed}
    footer{max-width:980px; margin:26px auto 0; color:#bbb; text-align:center; font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#ccc}
    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:20px; z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{width:min(880px,100%); background:#161616; border-radius:18px; color:#fff; box-shadow:0 24px 60px rgba(0,0,0,.6); overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .modal-header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px; background:linear-gradient(90deg, var(--cardGrad1), var(--cardGrad2))}
    .modal-title{font-size:22px; font-weight:800}
    .close-btn{border:none; background:rgba(0,0,0,.25); color:#fff; width:36px; height:36px; border-radius:10px; cursor:pointer; font-size:18px; display:grid; place-items:center}
    .modal-body{padding:18px}
    .modal-grid{display:grid; grid-template-columns:160px 1fr; gap:18px; align-items:start}
    .portrait{width:160px; height:160px; border-radius:14px; object-fit:cover; background:#222; box-shadow:0 10px 26px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.06)}
    .modal-avatar{width:160px; height:160px; border-radius:14px; display:grid; place-items:center; font-size:64px; font-weight:900; color:#2b1a12; background:radial-gradient(circle at 30% 30%, #ffd79a, #ff9f6b 50%, #ff7f50 70%); box-shadow:inset 0 0 0 2px rgba(255,255,255,.35), 0 10px 26px rgba(0,0,0,.35)}
    .detail-line{margin:6px 0; color:#eaeaea}
    .bio{margin-top:8px; color:#ddd; line-height:1.5; white-space:pre-wrap}
    .modal-chips{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
    .metric{background:#232; border:1px solid rgba(255,255,255,.08); padding:8px 12px; border-radius:10px; color:#cfeecf}
    .modal-footer{padding:14px 18px; background:#141414; border-top:1px solid rgba(255,255,255,.06); display:flex; gap:10px; justify-content:flex-end}
    .ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:10px; cursor:pointer}
    /* comments */
    .comments{margin-top:14px; padding-top:12px; border-top:1px solid rgba(255,255,255,.09)}
    .comment{background:#141414; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px 12px; margin:8px 0}
    .comment small{color:#bbb}
    .comment-form{display:grid; gap:8px; margin-top:10px}
    .comment-form input,.comment-form textarea{background:#222;border:1px solid rgba(255,255,255,.08); color:#fff;border-radius:8px;padding:10px}
    .comment-form button{justify-self:end}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img alt="iBandbyte logo" src="https://raw.githubusercontent.com/IBandbyte/assets/main/branding/orb-logo-64.png" onerror="this.style.display='none';" />
    </div>
    <div class="brand"><span class="iband">iBand</span><span class="byte">byte</span></div>
  </header>

  <section class="controls">
    <div class="search-row">
      <input id="q" type="text" placeholder="Search artistsâ€¦ (e.g. Drake, pop)" />
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
  </section>

  <main class="wrap" id="list"></main>

  <nav class="pager" aria-label="Pagination">
    <button id="prev" class="pbtn" disabled>â—€ï¸Ž Prev</button>
    <span id="pageInfo" class="info">Page 1 of 1</span>
    <button id="next" class="pbtn" disabled>Next â–¶ï¸Ž</button>
  </nav>

  <footer>Â© 2025 <span class="brand"><span class="iband">iBand</span><span class="byte">byte</span></span>. All rights reserved.</footer>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <article class="modal">
      <header class="modal-header">
        <div id="modalTitle" class="modal-title">Artist</div>
        <button class="close-btn" id="closeModal" aria-label="Close">âœ•</button>
      </header>
      <div class="modal-body">
        <div class="modal-grid">
          <!-- image OR avatar goes here -->
          <img id="mPortrait" class="portrait" alt="Artist image" style="display:none" />
          <div id="mAvatar" class="modal-avatar">A</div>

          <div>
            <div class="detail-line"><strong>Name:</strong> <span id="mName">â€”</span></div>
            <div class="detail-line"><strong>Genre:</strong> <span id="mGenre">â€”</span></div>
            <div class="modal-chips" id="mChips"></div>
            <div id="mBio" class="bio" style="display:none"></div>
            <div id="mMetrics" style="margin-top:10px; display:none">
              <span id="mVotes" class="metric" title="Votes"></span>
              <span id="mComments" class="metric" title="Comments"></span>
            </div>

            <!-- Comments -->
            <section class="comments" id="commentsSection" style="display:none">
              <h3 style="margin:6px 0 6px;">Comments</h3>
              <div id="commentsList"></div>
              <form id="commentForm" class="comment-form">
                <input id="cName" placeholder="Your name (optional)" />
                <textarea id="cText" rows="3" placeholder="Write a commentâ€¦"></textarea>
                <button class="btn" type="submit">Post comment</button>
              </form>
            </section>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ghost" id="mCopy">Copy name</button>
        <button class="btn" id="mAction">Open profile (soon)</button>
      </div>
    </article>
  </div>

  <script>
    const API_BASE = "https://iband-backend-first-2.onrender.com";
    const LIST_URL = API_BASE + "/artists";
    const PAGE_SIZE = 24;

    let rawData = [];
    let filtered = [];
    let currentPage = 1;
    let currentArtist = null; // for modal actions

    const $ = (s) => document.querySelector(s);

    function firstLetter(name="") {
      const t = (name || "").trim();
      return t ? t[0].toUpperCase() : "?";
    }

    function safeText(v, fallback="â€”"){ return (v==null || v==="") ? fallback : String(v); }

    function applyFilter(term){
      const q = (term||"").trim().toLowerCase();
      if(!q){ filtered=[...rawData]; return; }
      filtered = rawData.filter(a =>
        (a.name||"").toLowerCase().includes(q) ||
        (a.genre||"").toLowerCase().includes(q) ||
        (a.bio||"").toLowerCase().includes(q)
      );
    }

    function totalPages(){ return Math.max(1, Math.ceil(filtered.length / PAGE_SIZE)); }
    function pageSlice(){ const s=(currentPage-1)*PAGE_SIZE; return filtered.slice(s, s+PAGE_SIZE); }

    async function sendVote(id, btn){
      try{
        btn.disabled = true;
        const res = await fetch(`${API_BASE}/artists/${id}/vote`, { method:"POST" });
        const data = await res.json();
        if (data?.ok){
          // update in-memory + UI
          const artist = rawData.find(x => x._id === id);
          if (artist){ artist.votes = data.votes; }
          btn.querySelector(".vnum").textContent = data.votes;
          // also reflect in modal if open on same artist
          if (currentArtist && currentArtist._id === id){
            $("#mVotes").textContent = `â–² ${data.votes} votes`;
          }
        } else {
          alert(data?.error || "Vote failed");
        }
      } catch (e){
        alert("Network error while voting");
      } finally {
        btn.disabled = false;
      }
    }

    function renderList(){
      const list = $("#list"); list.innerHTML = "";
      const items = pageSlice();
      if(!items.length){ list.innerHTML = `<p class="mono">No results.</p>`; updatePager(); return; }

      const frag = document.createDocumentFragment();
      for(const a of items){
        const card = document.createElement("article");
        card.className = "card"; card.tabIndex = 0; card.role = "button";

        const name = safeText(a.name,"Unknown");
        const genre = safeText(a.genre,"No genre set");
        const votes = (typeof a.votes === "number") ? a.votes : 0;

        // avatar OR thumbnail
        let mediaHTML;
        if (a.imageUrl){
          mediaHTML = `<img class="thumb" src="${a.imageUrl}" alt="${name}">`;
        } else {
          mediaHTML = `<div class="avatar">${firstLetter(name)}</div>`;
        }

        card.innerHTML = `
          <div class="row">
            ${mediaHTML}
            <h2 class="name">${name}</h2>
            <button class="voteBtn" title="Vote"
              onclick="event.stopPropagation(); sendVote('${a._id}', this);">
              â–² <span class="vnum">${votes}</span>
            </button>
          </div>
          <div class="genre">${genre}</div>
          <div class="chips">
            <span class="chip">Artist</span>
            <span class="chip">${genre}</span>
          </div>
        `;

        card.addEventListener("click", ()=> openModal(a));
        card.addEventListener("keydown", (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModal(a); }});
        frag.appendChild(card);
      }
      list.appendChild(frag);
      updatePager();
    }

    function updatePager(){
      $("#pageInfo").textContent = `Page ${currentPage} of ${totalPages()}`;
      $("#prev").disabled = currentPage<=1;
      $("#next").disabled = currentPage>=totalPages();
    }

    // ===== Modal logic =====
    const backdrop = $("#backdrop");
    const mPortrait = $("#mPortrait");
    const mAvatar   = $("#mAvatar");
    const mNameEl   = $("#mName");
    const mGenreEl  = $("#mGenre");
    const mChips    = $("#mChips");
    const mBio      = $("#mBio");
    const mMetrics  = $("#mMetrics");
    const mVotes    = $("#mVotes");
    const mComments = $("#mComments");
    const commentsSection = $("#commentsSection");
    const commentsList = $("#commentsList");
    const commentForm = $("#commentForm");
    const cName = $("#cName");
    const cText = $("#cText");

    function openModal(a){
      currentArtist = a;

      const name  = safeText(a.name,"Unknown");
      const genre = safeText(a.genre,"No genre set");
      $("#modalTitle").textContent = "Artist";
      mNameEl.textContent  = name;
      mGenreEl.textContent = genre;

      // Image or avatar
      if (a.imageUrl){
        mPortrait.src = a.imageUrl;
        mPortrait.style.display = "block";
        mAvatar.style.display   = "none";
      } else {
        mAvatar.textContent = firstLetter(name);
        mAvatar.style.display = "grid";
        mPortrait.style.display = "none";
      }

      // Chips
      mChips.innerHTML = "";
      const c1 = document.createElement("span"); c1.className="chip"; c1.textContent="Artist";
      const c2 = document.createElement("span"); c2.className="chip"; c2.textContent=genre;
      mChips.append(c1,c2);

      // Bio (optional)
      if (a.bio && a.bio.trim()){
        mBio.textContent = a.bio.trim();
        mBio.style.display = "block";
      } else {
        mBio.style.display = "none";
      }

      // Metrics
      const votesOk = (typeof a.votes === "number");
      const commentsCount =
        Array.isArray(a.comments) ? a.comments.length :
        (typeof a.commentsCount === "number" ? a.commentsCount : 0);

      mMetrics.style.display = (votesOk || commentsCount!=null) ? "block" : "none";
      if (votesOk){ mVotes.style.display="inline-block"; mVotes.textContent = `â–² ${a.votes} votes`; } else { mVotes.style.display="none"; }
      if (commentsCount!=null){ mComments.style.display="inline-block"; mComments.textContent = `ðŸ’¬ ${commentsCount} comments`; } else { mComments.style.display="none"; }

      // Reset comments UI and fetch
      commentsList.innerHTML = "";
      commentsSection.style.display = "block";
      cText.value = "";
      fetchComments(a._id);

      backdrop.classList.add("show");
      $("#closeModal").focus();
    }

    function closeModal(){ backdrop.classList.remove("show"); }
    $("#closeModal").addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    $("#mCopy").addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mNameEl.textContent); alert("Copied artist name"); }catch{}
    });
    $("#mAction").addEventListener("click", ()=> alert("Profile page coming soon âœ¨"));

    async function fetchComments(id){
      try{
        const res = await fetch(`${API_BASE}/artists/${id}/comments`);
        const data = await res.json();
        commentsList.innerHTML = "";
        (data?.comments || []).forEach(c=>{
          const div = document.createElement("div");
          div.className = "comment";
          const d = new Date(c.createdAt);
          div.innerHTML = `<strong>${safeText(c.name,"Anon")}</strong> <small>Â· ${d.toLocaleString()}</small><div style="margin-top:6px">${safeText(c.text,"")}</div>`;
          commentsList.appendChild(div);
        });
      } catch (e){
        commentsList.innerHTML = `<p class="mono">Failed to load comments</p>`;
      }
    }

    commentForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!currentArtist) return;
      const name = cName.value.trim();
      const text = cText.value.trim();
      if (!text) { alert("Please write a comment"); return; }
      try{
        const res = await fetch(`${API_BASE}/artists/${currentArtist._id}/comments`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ name, text })
        });
        const data = await res.json();
        if (data?.ok){
          // update counters
          const a = rawData.find(x=>x._id===currentArtist._id);
          if (a){
            a.commentsCount = data.count;
            currentArtist.commentsCount = data.count;
            mComments.textContent = `ðŸ’¬ ${data.count} comments`;
          }
          cText.value = "";
          fetchComments(currentArtist._id);
        } else {
          alert(data?.error || "Failed to post comment");
        }
      } catch (e){
        alert("Network error while posting");
      }
    });

    // ===== Fetch + events =====
    async function fetchArtists(){
      try{
        $("#refreshBtn").disabled = true;
        const res = await fetch(LIST_URL, { cache:"no-store" });
        const data = await res.json();
        rawData = Array.isArray(data) ? data : [];
        applyFilter($("#q").value);
        currentPage=1; renderList();
      }catch(err){
        $("#list").innerHTML = `<p class="mono">Error: ${err?.message||err}</p>`;
      }finally{
        $("#refreshBtn").disabled = false;
      }
    }

    $("#q").addEventListener("input", e => { applyFilter(e.target.value); currentPage=1; renderList(); });
    $("#refreshBtn").addEventListener("click", fetchArtists);
    $("#prev").addEventListener("click", ()=>{ if(currentPage>1){ currentPage--; renderList(); }});
    $("#next").addEventListener("click", ()=>{ if(currentPage<totalPages()){ currentPage++; renderList(); }});
    window.addEventListener("keydown", (e)=>{ if(e.key==="ArrowLeft")$("#prev").click(); if(e.key==="ArrowRight")$("#next").click(); });

    fetchArtists();
  </script>
</body>
</html>